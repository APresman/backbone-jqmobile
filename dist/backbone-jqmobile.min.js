/* ######## UTIL ############# */window.jumpui=window.jumpui||{},jumpui.util=jumpui.util||{},jumpui.util.serializeForm=function(e){if(e==undefined||!e.length)throw"No elements found in the form";var t={},n=t;return e.find(':input[type!="checkbox"][type!="radio"], input:checked').each(function(){var e=this.name.replace(/\[([^\]]+)?\]/g,",$1").split(","),r=e.length-1,i=0;if(e[0]){for(;i<r;i++)n=n[e[i]]=n[e[i]]||(e[i+1]==""?[]:{});n.length!=undefined?n.push($(this).val()):n[e[r]]?_.isArray(n[e[r]])?n[e[r]].push($(this).val()):n[e[r]]=[n[e[r]],$(this).val()]:$(this).attr("data-field")=="array"?n[e[r]]=[$(this).val()]:n[e[r]]=$(this).val(),n=t}}),t},$(document).bind("mobileinit",function(){console.log("setting Jquery mobile on mobile init"),$.mobile.ajaxEnabled=!1,$.mobile.linkBindingEnabled=!1,$.mobile.hashListeningEnabled=!1,$.mobile.pushStateEnabled=!1}),window.jumpui=window.jumpui||{},jumpui.JqmApp=Backbone.Model.extend({initialize:function(){if(this.attributes.platform==undefined)throw"Platform is not specified for this app";if(this.attributes.containerEl==undefined)throw"containerEl is not specified for this app";_.extend(this,this.attributes),this.pages={},this.router=new Backbone.Router,this.platform.setup()},load:function(e){e=e||{};if(this.pages.length<=0)throw"No pages found in app";$(this.containerEl).live("pageshow",function(e,t){$(t.prevPage).remove()}),Backbone.history.start()},addPage:function(e){if(this.router==undefined)throw"Cannot add page before router is set in Application";e.app=this,this.theme&&(e.attributes["data-theme"]=this.theme),this._registerPage(e),this.pages[e.name]=e},navigate:function(e){this.router.navigate(e,{trigger:!0})},_registerPage:function(e){var t=this;this.router.route(e.route,e.name,function(){var n=arguments;e._load(n,$(t.containerEl))?(t.currentPage&&(t.currentPage.visible=!1),t.currentPage=e,t.currentPage.visible=!0,$(e.el).trigger("jui-pageloaded")):console.log("Not loading page "+e.name+" as process returned negetive")})},_jQChangePage:function(e){$.mobile.changePage($(e.el))}}),jumpui.Platform=Backbone.Model.extend({initialize:function(){},setup:function(){}}),jumpui.Platform.CORDOVA=new jumpui.Platform({}),jumpui.Platform.WEB=new jumpui.Platform({}),jumpui.internal={},jumpui.internal.AbstractView=Backbone.View.extend({initialize:function(){_.extend(this,this.options);if(this.ui){var e=this;this._ui||(this._ui=_.clone(this.ui));var t=this._ui;_.each(t,function(t,n){console.log("fetch "+n+", "+t),e.ui[n]=e.$(t)})}this.init&&this.init()},close:function(){this.remove(),this.unbind(),this.onClose&&this.onClose()}}),jumpui.template={},jumpui.template.engine={},jumpui.TemplateEngine=Backbone.Model.extend({parse:function(e,t){return e}}),jumpui.template.engine.Underscore=jumpui.TemplateEngine.extend({parse:function(e,t){throw"UNDERSCORE not implemented yet"}}),jumpui.template.engine.Handlebars=jumpui.TemplateEngine.extend({initialize:function(e){_.extend(this,e);var t=this.helpers||{};_.each(_.keys(t),function(e){Handlebars.registerHelper(e,t[e])})},parse:function(e,t,n){var r=$("#"+e).html();return this.parseHtml(r,t,n)},parseHtml:function(e,t,n){var r=Handlebars.compile(e);return t.fragments=n,r(t)},registerPartial:function(e){Handlebars.registerPartial(e,$("#"+e).html())}}),jumpui.fragment={},jumpui.Fragment=jumpui.internal.AbstractView.extend({initialize:function(){jumpui.internal.AbstractView.prototype.initialize.apply(this,arguments),this.dataFragment=this.template},getModel:function(){return{}},render:function(){this.$el&&this.$el.empty();if($.isFunction(this.template)){this.$el.append(this.block.page.app.templateEngine.parseHtml(this.template(this.getModel()),this.getModel()));return}if(this.template!=undefined){this.$el.append(this.block.page.app.templateEngine.parse(this.template,this.getModel()));return}if(this.getContent==null)throw"Neither template nor getContent method found";$(this.el).empty().append($(this.getContent()))},createHtml:function(e,t){return"<"+this.tagName+" id='"+this.id+"'>"+e.parse(this.template,t)+"</"+this.tagName+">"},_setEl:function(e){this.setElement(e)}}),jumpui.block={},jumpui.Block=jumpui.internal.AbstractView.extend({tagName:"div",fragments:{},initialize:function(){jumpui.internal.AbstractView.prototype.initialize.apply(this,arguments);var e=this;_.each(this.fragments,function(t){t.block=e})},render:function(){$(this.el).remove(),this.setElement(this.make(this.tagName,this.attributes));var e=$(this.el);if(this.template){var t=this,n={};$.isFunction(this.template)?e.append(this.page.app.templateEngine.parseHtml(this.template(this.model),this.model,n)):this.template!=undefined&&e.append(this.page.app.templateEngine.parse(this.template,this.model,n)),_.each(this.fragments,function(e,n){e._setEl(t.$("[data-fragment="+n+"]")),e.render()});return}if(this.getContent==null)throw"Neither template nor getContent method found";$(this.el).empty().append($(this.getContent()))}}),jumpui.block.Header=jumpui.Block.extend({className:"jump-header",attributes:{"data-role":"header"}}),jumpui.block.Footer=jumpui.Block.extend({className:"jump-footer",attributes:{"data-role":"footer"}}),jumpui.block.Content=jumpui.Block.extend({className:"jump-content",attributes:{"data-role":"content"}}),jumpui.Page=Backbone.View.extend({tagName:"div",className:"jump-page",attributes:{"data-role":"page"},initialize:function(e){_.bindAll(this,"reload");if(e==undefined||e.name==undefined)throw"name property is compulsory";if(e.prepare==undefined)throw"prepare property is compulsory";_.extend(this,e),this.id=e.name,this.loaded=!1,this.route==undefined&&(this.route=this.name),this.setBlocks(e.blocks||{});if(this.ui){this._ui||(this._ui=_.clone(this.ui));var t=this._ui;_.each(t,function(e,t){console.log("fetch "+t+", "+e),self.ui[t]=self.$(e)})}this.init&&this.init()},setBlocks:function(e){var t=this;this.blocks=e,_.each(this.blocks,function(e){e.page=t})},isLoaded:function(){return!1},_attachAndProcess:function(e){e.append(this.el),$(this.el).page(),this.loaded=!0},load:function(e){e.append(this.el),$(this.el).page(),this.loaded=!0},_createDom:function(){var e=this;this.setElement(this.make(this.tagName,this.attributes)),_.each(_.keys(this.blocks),function(t){var n=e.blocks[t];n.model==undefined&&(n.model={}),_.extend(n.model,n.page.model),n.render(),$(e.el).append(n.el)})},render:function(){console.log("Rendering "+this.name,this),this._createDom(),$(this.el).trigger("jui-pagerendered")},_load:function(e,t){var n=!1;n=this.prepare.apply(this,e);if(!n)return;return _.each(this.blocks,function(t){if(t.prepare)return n=t.prepare.apply(t,e),n}),n?(this.render(),this._attachAndProcess(t),this.app._jQChangePage(this),!0):!1},reload:function(e){e=e||[];if(!$.isArray(e))throw console.log("Arguments must be array",e),"Arguments must be array";return this.visible?(console.log("reloading page "+this.name),this._load(e,$(this.app.containerEl))):(console.log("Unable to reload page "+this.name+", as page is not current/visible page"),!1)}}),jumpui.fragment=jumpui.fragment||{},jumpui.fragment.ListItem=Backbone.View.extend({tagName:"li",attribute:"name",model:undefined,templateEngine:undefined,initialize:function(e){this.templateEngine=e.templateEngine},render:function(){if(this.template){var e=_.isFunction(this.model.toJSON)?this.model.toJSON():this.model;$.isFunction(this.template)?this.$el.html(this.templateEngine.parseHtml(this.template(e),e)):this.$el.html(this.templateEngine.parse(this.template,e))}else this.$el.html(this.model.get(this.attribute))}}),jumpui.fragment.formItems={text:jumpui.internal.AbstractView.extend({tagName:"input"}),password:jumpui.internal.AbstractView.extend({tagName:"input"}),number:jumpui.internal.AbstractView.extend({tagName:"input"}),submit:jumpui.internal.AbstractView.extend({tagName:"input",attributes:{type:"submit"},initialize:function(e){e.show===!1&&this.$el.hide(),this.$el.attr("value",e.value)}}),reset:jumpui.internal.AbstractView.extend({tagName:"input",attributes:{type:"reset"},initialize:function(e){e.show===!1&&this.$el.hide(),this.$el.attr("value",e.value)}}),range:jumpui.internal.AbstractView.extend({tagName:"input",attributes:{type:"range","data-highlight":!0}}),select:jumpui.internal.AbstractView.extend({tagName:"select",initialize:function(e){var t=this;this.attributes&&this.attributes.options&&_.each(this.attributes.options,function(e){var n=$("<option>").attr("value",e).html(e);t.attributes.value==e&&n.attr("selected","selected"),t.$el.append(n)})}}),radiogroup:jumpui.internal.AbstractView.extend({tagName:"fieldset",attributes:{"data-role":"controlgroup"},initialize:function(e){var t=this;this.attributes.options&&_.each(this.attributes.options,function(e){var n=$("<input>").attr({type:"radio",value:e,name:t.attributes.name,id:e}).html(e),r=$("<label>").attr("for",e).html(e);t.attributes.value==e&&n.attr("checked","checked"),t.$el.append(n),t.$el.append(r)})}}),checkboxgroup:jumpui.internal.AbstractView.extend({tagName:"fieldset",attributes:{"data-role":"controlgroup"},initialize:function(e){var t=this;this.attributes.options&&_.each(this.attributes.options,function(e){var n=$("<input>").attr({type:"checkbox",value:e,name:t.attributes.name,id:e,"data-field":"array"}).html(e),r=$("<label>").attr("for",e).html(e);_.contains(t.attributes.value,e)&&n.attr("checked","checked"),t.$el.append(n),t.$el.append(r)}),this.$el.bind("change",function(e){var n=$(e.target).val();$(e.target).attr("checked")||t.model.set(t.attributes.name,_.difference(t.model.get(t.attributes.name),n),{silent:!0})})}}),textarea:jumpui.internal.AbstractView.extend({tagName:"textarea"})},jumpui.fragment.FormFooter=jumpui.internal.AbstractView.extend({tagName:"div",attributes:{"class":"ui-body"},initialize:function(e,t){this.submit=e,this.reset=t},render:function(){var e=$("<fieldset>").attr("class","ui-grid-a");if(this.submit.show){var t=$("<div>").addClass("ui-block-a").append((new jumpui.fragment.formItems.submit({value:this.submit.label})).$el);e.append(t)}if(this.reset.show){var n=$("<div>").addClass("ui-block-b").append((new jumpui.fragment.formItems.reset({value:this.reset.label})).$el);e.append(n)}return this.$el.append(e),this.$el}}),jumpui.fragment.Form=jumpui.Fragment.extend({model:undefined,items:undefined,itemsEl:[],submitButton:{show:!0,label:"Submit"},resetButton:{show:!0,label:"Cancel"},formFooter:jumpui.fragment.FormFooter,events:{"submit form":"submit"},init:function(){var e=this;this.options=_.defaults({action:"javascript:;"}),this.model.on("error",function(t,n){e.errorEl.html(n),e.errorEl.show()})},_createItem:function(e,t){var n=$("<div>").attr("data-role","fieldcontain");n.append($("<label>").attr("for",e.name).text(e.label)),e.value=this.model.get(e.name),e.id=e.name;var r=_.extend(e,e.data||{}),i=new jumpui.fragment.formItems[e.type]({attributes:_.extend(r,jumpui.fragment.formItems[e.type].prototype.attributes),model:this.model});return this.itemsEl.push(i),i.$el.bind("change",function(){}),i.render(),n.append(i.$el),n},getContainer:function(){this.errorEl=$("<div class='error'>this is error</div>"),this.$el.append(this.errorEl);var e=$("<form></form>").attr("action",this.options.action);return e},render:function(){var e=this.getContainer(),t=this;_.each(this.items,function(n){var r=t._createItem(n,e);e.append(r)}),e.append((new this.formFooter(this.submitButton,this.resetButton)).render()),this.$el.append(e)},getValues:function(){return jumpui.util.serializeForm(this.$el)},submit:function(){this.errorEl.hide();var e=this.getValues();this.model.set(e)&&this.onSubmit&&this.onSubmit()}}),jumpui.fragment.List=jumpui.Fragment.extend({collection:undefined,ItemView:undefined,options:{inset:!1},init:function(){_.bindAll(this,"refresh");if(this.collection===undefined)throw"Collection is null";this.collection.on("reset",this.refresh),this.collection.on("add",this.refresh),this.collection.on("remove",this.refresh)},refresh:function(){this.render(),this.$("ul").listview()},getModel:function(){return{list:this.collection.toJSON()}},getContainer:function(){var e=$("<ul></ul>");return e.attr("data-role","listview"),e.attr("data-inset",this.options.inset),e},render:function(){this.$el.empty();var e=this.getContainer(),t=this,n=this.block.page.app.templateEngine;this.collection.each(function(r){var i=new t.ItemView({model:r,templateEngine:n});i.render(),e.append(i.$el)}),this.$el.append(e)}});